<div class="ident-schedule" id="identSchedule"
  data-api-url="https://ident.dentaplus-norilsk.ru">
  <div class="ident-schedule-header">
    <h2>Расписание врачей</h2>
  </div>
  <div class="ident-schedule-filters">
    <select id="doctorFilter">
      <option value>Все врачи</option>
    </select>
    <select id="branchFilter">
      <option value>Все филиалы</option>
    </select>
    <select id="statusFilter">
      <option value="free">Свободно</option>
      <option value="busy">Занято</option>
      <option value>Все</option>
    </select>
    <input type="date" id="dateFrom" />
    <input type="date" id="dateTo" />
    <button onclick="identLoadSchedule()">Показать</button>
  </div>
  <div id="scheduleContent"></div>
  <div id="schedulePagination" style="display:none; margin-top:20px; text-align:center;">
    <button id="prevPage" disabled>← Назад</button>
    <span id="pageInfo" style="margin:0 12px;"></span>
    <button id="nextPage">Вперёд →</button>
  </div>
</div>

<style>
	.ident-schedule {
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
		max-width: 1200px;
		margin: 20px 0;
		padding: 20px;
	}
	.ident-schedule-header {
		margin-bottom: 20px;
	}
	.ident-schedule-filters {
		display: flex;
		gap: 15px;
		margin-bottom: 20px;
		flex-wrap: wrap;
	}
	.ident-schedule-filters select,
	.ident-schedule-filters input {
		padding: 8px 12px;
		border: 1px solid #ddd;
		border-radius: 4px;
		font-size: 14px;
	}
	.ident-schedule-filters button {
		padding: 8px 16px;
		background-color: #0073aa;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 14px;
	}
	.ident-schedule-filters button:hover {
		background-color: #005a87;
	}
	.ident-schedule-loading {
		text-align: center;
		padding: 40px;
		color: #666;
	}
	.ident-schedule-error {
		background-color: #f8d7da;
		color: #721c24;
		padding: 12px;
		border-radius: 4px;
		margin-bottom: 20px;
	}
	.ident-schedule-table {
		width: 100%;
		border-collapse: collapse;
		background: white;
		box-shadow: 0 1px 3px rgba(0,0,0,0.1);
	}
	.ident-schedule-table th {
		background-color: #f1f1f1;
		padding: 12px;
		text-align: left;
		border-bottom: 2px solid #ddd;
		font-weight: 600;
	}
	.ident-schedule-table td {
		padding: 12px;
		border-bottom: 1px solid #eee;
	}
	.ident-schedule-table tr:hover {
		background-color: #f9f9f9;
	}
	.ident-schedule-busy {
		color: #d63638;
		font-weight: 600;
	}
	.ident-schedule-free {
		color: #00a32a;
		font-weight: 600;
	}
	.ident-schedule-empty {
		text-align: center;
		padding: 40px;
		color: #666;
	}
	.ident-schedule-book {
		padding: 6px 12px;
		background-color: #0073aa;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 13px;
	}
	.ident-schedule-book:hover {
		background-color: #005a87;
	}
	.ident-schedule-book:disabled {
		background-color: #9e9e9e;
		cursor: not-allowed;
	}
  /* ===== MOBILE ADAPTIVE ===== */
  @media (max-width: 768px) {

    .ident-schedule {
      padding: 10px;
    }

    .ident-schedule-header h2 {
      font-size: 20px;
    }

    .ident-schedule-filters {
      flex-direction: column;
      gap: 10px;
    }

    .ident-schedule-filters select,
    .ident-schedule-filters input,
    .ident-schedule-filters button {
      width: 100%;
      font-size: 16px;
      padding: 0px 12px;
    }

    /* Таблицу превращаем в карточки */
    .ident-schedule-table,
    .ident-schedule-table thead,
    .ident-schedule-table tbody,
    .ident-schedule-table th,
    .ident-schedule-table tr {
      display: block;
    }

    .ident-schedule-table thead {
      display: none;
    }

    .ident-schedule-table tr {
      background: #fff;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      padding: 12px;
    }

    .ident-schedule-table td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border: none;
      font-size: 14px;
    }

    .ident-schedule-table td::before {
      content: attr(data-label);
      font-weight: 600;
      color: #555;
      margin-right: 10px;
    }

    .ident-schedule-book {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      margin-top: 10px;
    }

    .action-th {
      display: none;
    }
  }
  #schedulePagination button {
    padding: 8px 14px;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
  }

  #schedulePagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }


</style>

<script>
	(function() {
		const scheduleContainer = document.getElementById('identSchedule');
		let API_BASE_URL = scheduleContainer?.getAttribute('data-api-url');
		
		if (!API_BASE_URL) {
			const currentHost = window.location.hostname;
			const currentPort = window.location.port;
			if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
				API_BASE_URL = 'http://localhost:5100';
			} else {
				API_BASE_URL = `http://${currentHost}:5100`;
			}
		}
		
		let doctors = [];
		let branches = [];
    let currentPage = 1
    const pageSize = 10 // сколько интервалов на страницу
    let lastIntervalsCount = 0


		async function identLoadDoctors() {
			try {
				const response = await fetch(`${API_BASE_URL}/GetDoctors`);
				if (!response.ok) {
					const errorText = await response.text();
					throw new Error(`Ошибка загрузки врачей: ${response.status} ${errorText}`);
				}
				doctors = await response.json();
				const select = document.getElementById('doctorFilter');
				while (select.children.length > 1) {
					select.removeChild(select.lastChild);
				}
				doctors.forEach(doctor => {
					const option = document.createElement('option');
					option.value = doctor.Id;
					option.textContent = doctor.Name;
					select.appendChild(option);
				});
			} catch (error) {
				console.error('Ошибка загрузки врачей:', error);
				const content = document.getElementById('scheduleContent');
				if (content && !content.innerHTML.includes('Ошибка')) {
					content.innerHTML = `<div class="ident-schedule-error">Ошибка подключения к API (${API_BASE_URL}). Проверьте, что сервер доступен.</div>`;
				}
			}
		}

		async function identLoadBranches() {
			try {
				const response = await fetch(`${API_BASE_URL}/GetBranches`);
				if (!response.ok) {
					const errorText = await response.text();
					throw new Error(`Ошибка загрузки филиалов: ${response.status} ${errorText}`);
				}
				branches = await response.json();
				const select = document.getElementById('branchFilter');
				while (select.children.length > 1) {
					select.removeChild(select.lastChild);
				}
				branches.forEach(branch => {
					const option = document.createElement('option');
					option.value = branch.Id;
					option.textContent = branch.Name;
					select.appendChild(option);
				});
			} catch (error) {
				console.error('Ошибка загрузки филиалов:', error);
			}
		}

		window.identLoadSchedule = async function() {
      if (window.__identFilterChanged) {
        currentPage = 1
        window.__identFilterChanged = false
      }

			const content = document.getElementById('scheduleContent');
			content.innerHTML = '<div class="ident-schedule-loading">Загрузка...</div>';

			const doctorId = document.getElementById('doctorFilter').value;
			const branchId = document.getElementById('branchFilter').value;
			const statusFilter = document.getElementById('statusFilter').value;
			const dateFrom = document.getElementById('dateFrom').value;
			const dateTo = document.getElementById('dateTo').value;

			const params = new URLSearchParams();
			if (doctorId) params.append('doctorId', doctorId);
			if (branchId) params.append('branchId', branchId);
			if (dateFrom) {
				const fromDate = new Date(dateFrom + 'T00:00:00');
				params.append('dateTimeFrom', fromDate.toISOString());
			}
			if (dateTo) {
				const toDate = new Date(dateTo + 'T23:59:59');
				params.append('dateTimeTo', toDate.toISOString());
			}

			try {
        const offset = (currentPage - 1) * pageSize
        params.append('limit', pageSize)
        params.append('offset', offset)

				const response = await fetch(`${API_BASE_URL}/GetSchedule?${params.toString()}`);
				if (!response.ok) {
					const errorText = await response.text();
					throw new Error(errorText || 'Ошибка загрузки расписания');
				}
				let intervals = await response.json();
        lastIntervalsCount = intervals.length
				if (statusFilter === 'free') {
					intervals = intervals.filter(interval => !interval.IsBusy);
				} else if (statusFilter === 'busy') {
					intervals = intervals.filter(interval => interval.IsBusy);
				}
				identDisplaySchedule(intervals);
        updatePagination()
			} catch (error) {
				content.innerHTML = `<div class="ident-schedule-error">Ошибка: ${error.message}</div>`;
			}
		}

		function identDisplaySchedule(intervals) {
			const content = document.getElementById('scheduleContent');
			
			if (intervals.length === 0) {
				content.innerHTML = '<div class="ident-schedule-empty">Расписание не найдено</div>';
				return;
			}

			let html = '<table class="ident-schedule-table">';
			html += '<thead><tr>';
			html += '<th>Филиал</th>';
			html += '<th>Врач</th>';
			html += '<th>Дата и время</th>';
			html += '<th>Длительность</th>';
			html += '<th>Статус</th>';
			html += '<th class="action-th">Действие</th>';
			html += '</tr></thead><tbody>';

			intervals.forEach((interval, idx) => {
				const startDate = new Date(interval.StartDateTime);
				const dateStr = startDate.toLocaleDateString('ru-RU', {
					day: '2-digit',
					month: '2-digit',
					year: 'numeric'
				});
				const timeStr = startDate.toLocaleTimeString('ru-RU', {
					hour: '2-digit',
					minute: '2-digit'
				});
        const isMobile = window.innerWidth <= 600
				const statusClass = interval.IsBusy ? 'ident-schedule-busy' : 'ident-schedule-free';
				const statusText = interval.IsBusy ? 'Занято' : 'Свободно';
				const actionCell = interval.IsBusy
          ? '<td data-label="Действие"><button class="ident-schedule-book" disabled>Недоступно</button></td>'
          : `<td data-label="Действие"><button class="ident-schedule-book" data-idx="${idx}">Запись</button></td>`;
        
        const actionCellMobile = interval.IsBusy
          ? '<td><button class="ident-schedule-book" disabled>Недоступно</button></td>'
          : `<td><button class="ident-schedule-book" data-idx="${idx}">Запись</button></td>`;


				html += '<tr>';
				html += `<td data-label="Филиал">${identEscapeHtml(interval.BranchName)}</td>`;
				html += `<td data-label="Врач">${identEscapeHtml(interval.DoctorName)}</td>`;
				html += `<td data-label="Дата и время">${dateStr} ${timeStr}</td>`;
				html += `<td data-label="Длительность">${interval.LengthInMinutes} мин</td>`;
				html += `<td data-label="Статус" class="${statusClass}">${statusText}</td>`;

				html += isMobile ? actionCellMobile : actionCell;
				html += '</tr>';
			});

			html += '</tbody></table>';
			content.innerHTML = html;

			const buttons = content.querySelectorAll('.ident-schedule-book');
			buttons.forEach((btn) => {
				const idx = btn.getAttribute('data-idx');
				const interval = intervals[Number(idx)];
				btn.addEventListener('click', () => identBook(interval));
			});
		}

    function updatePagination() {
      const pagination = document.getElementById('schedulePagination')
      const prevBtn = document.getElementById('prevPage')
      const nextBtn = document.getElementById('nextPage')
      const pageInfo = document.getElementById('pageInfo')

      pagination.style.display = 'block'
      pageInfo.textContent = `Страница ${currentPage}`

      prevBtn.disabled = currentPage === 1
      nextBtn.disabled = lastIntervalsCount < pageSize
    }

    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--
        identLoadSchedule()
      }
    })

    document.getElementById('nextPage').addEventListener('click', () => {
      if (lastIntervalsCount === pageSize) {
        currentPage++
        identLoadSchedule()
      }
    })

		function identEscapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function identCollectUtm() {
			const params = new URLSearchParams(window.location.search);
			return {
				UtmSource: params.get('utm_source') || undefined,
				UtmMedium: params.get('utm_medium') || undefined,
				UtmCampaign: params.get('utm_campaign') || undefined,
				UtmTerm: params.get('utm_term') || undefined,
				UtmContent: params.get('utm_content') || undefined,
			};
		}

		async function identBook(interval) {
			const phone = window.prompt('Введите телефон для связи');
			if (!phone || phone.trim() === '') {
				return;
			}

			const fullName = window.prompt('Введите ФИО (необязательно)') || '';
			const comment = window.prompt('Комментарий (необязательно)') || '';

			const payload = {
				BranchId: interval.BranchId,
				DoctorId: interval.DoctorId,
				StartDateTime: interval.StartDateTime,
				LengthInMinutes: interval.LengthInMinutes,
				ClientPhone: phone.trim(),
				ClientFullName: fullName.trim() || undefined,
				Comment: comment.trim() || undefined,
				DoctorName: interval.DoctorName,
				HttpReferer: document.referrer || window.location.href,
				FormName: 'WidgetBooking',
				...identCollectUtm(),
			};

			try {
				const response = await fetch(`${API_BASE_URL}/BookTicket`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(payload),
				});

				if (!response.ok) {
					const errorText = await response.text();
					throw new Error(errorText || 'Ошибка при записи');
				}

				window.alert('Заявка отправлена');
				identLoadSchedule();
			} catch (error) {
				window.alert(error.message);
			}
		}

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', function() {
				identLoadDoctors();
				identLoadBranches();
				const today = new Date().toISOString().split('T')[0];
				document.getElementById('dateFrom').value = today;
				document.getElementById('statusFilter').value = 'free';
				identLoadSchedule();
        // вешаем флаг на фильтры
        ['doctorFilter','branchFilter','statusFilter','dateFrom','dateTo']
        .forEach(id => {
          document.getElementById(id).addEventListener('change', () => {
            window.__identFilterChanged = true
          })
        })

			});
		} else {
			identLoadDoctors();
			identLoadBranches();
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('dateFrom').value = today;
			document.getElementById('statusFilter').value = 'free';
			identLoadSchedule();
		}
	})();
</script>